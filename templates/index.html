<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞—Ñ–∏–∫ –¥–µ–∂—É—Ä—Å—Ç–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container-tv">
        <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
        <button class="refresh-btn" onclick="refreshData()" title="–û–±–Ω–æ–≤–∏—Ç—å">
            ‚ü≥
        </button>
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header">
            <h1 class="display-4 mb-0">üìÖ –ì—Ä–∞—Ñ–∏–∫ –≤–µ—á–µ—Ä–Ω–∏—Ö –¥–µ–∂—É—Ä—Å—Ç–≤</h1>
            <div class="current-time">
                {{ today.strftime('%d.%m.%Y') }} <span class="time-separator">|</span> {{ current_time }}
            </div>
        </div>
        
        <!-- –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–∂—É—Ä–Ω—ã–π -->
        <div class="today-section">
            <div class="today-date">
                –°–µ–≥–æ–¥–Ω—è: {{ today.strftime('%d.%m.%Y') }} <span class="time-separator">|</span> {{ current_time }}
            </div>
            {% if today_duty %}
            <div class="today-duty">
                {{ today_duty.name }}
            </div>
            {% elif error %}
            <div class="error-duty">
                ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
            </div>
            {% else %}
            <div class="no-duty">
                –ù–∞ —Å–µ–≥–æ–¥–Ω—è –¥–µ–∂—É—Ä–Ω—ã–π –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
            </div>
            {% endif %}
        </div>
        
        <!-- –ë–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
        <div class="schedule-section">
            {% if error %}
                <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ -->
                <div class="error-container">
                    <div class="alert alert-danger">
                        <h4>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</h4>
                        <p>{{ error }}</p>
                        <hr>
                        <small class="text-muted">
                            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥...
                        </small>
                    </div>
                </div>
            {% elif weeks %}
                <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è -->
                {% for week in weeks %}
                <div class="week-row">
                    <div class="week-dates">
                        {{ week[0].date.strftime('%d.%m') }} - {{ week[-1].date.strftime('%d.%m') }}
                    </div>
                    <div class="weekdays-header">
                        {% for duty in week %}
                        <div class="weekday-cell">
                            {{ duty.weekday }}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="row">
                        {% for duty in week %}
                        <div class="col day-cell {% if duty.date == today %}today-highlight{% endif %}">
                            <div class="date-header">
                                {{ duty.date.strftime('%d.%m') }}
                            </div>
                            <div class="duty-name">
                                {{ duty.name }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-muted py-4">
                    –ù–µ—Ç –¥–µ–∂—É—Ä—Å—Ç–≤ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 2 –Ω–µ–¥–µ–ª–∏
                </div>
            {% endif %}
        </div>
        
        <!-- –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
        <div class="last-updated">
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ last_updated }}
        </div>
    </div>

    <script>
    function refreshData() {
        fetch('/refresh')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else if (data.error) {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ru-RU', { 
            hour: '2-digit', 
            minute: '2-digit'
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        const timeElements = document.querySelectorAll('.current-time, .today-date');
        timeElements.forEach(element => {
            const datePart = element.textContent.split('|')[0];
            element.innerHTML = datePart + '<span class="time-separator">|</span> ' + timeString;
        });
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    function checkForErrorsAndRefresh() {
        const errorContainer = document.querySelector('.error-container');
        if (errorContainer) {
            console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥...');
            setTimeout(() => {
                location.reload();
            }, 15000);
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å—Ä–∞–∑—É –∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
    updateTime();
    setInterval(updateTime, 60000);
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫)
    setInterval(() => {
        const errorContainer = document.querySelector('.error-container');
        if (!errorContainer) {
            refreshData();
        }
    }, 300000);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        checkForErrorsAndRefresh();
        
        // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        document.body.style.opacity = '0';
        document.body.style.transition = 'opacity 0.5s ease-in-out';
        
        setTimeout(() => {
            document.body.style.opacity = '1';
        }, 100);
    });
    </script>
</body>
</html>